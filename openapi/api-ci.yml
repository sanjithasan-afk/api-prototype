name: API Governance & Deployment CI

on:
  push:
    branches: [ main ]
    paths:
      - "openapi/**"
      - "postman/**"
      - "scripts/**"
  pull_request:
    branches: [ main ]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install Spectral & Newman
        run: |
          npm install -g @stoplight/spectral-cli newman

      - name: Lint OpenAPI
        run: |
          spectral lint openapi/orders.yaml --fail-severity warn

      - name: Run Postman Tests
        run: |
          newman run postman/OrdersAPI_AutoGenerated.postman_collection.json \
            --env-var base_url=https://api.example.com/v1 \
            --env-var api_key=${{ secrets.API_KEY }}

      - name: Upload Test Report
        if: always()
        run: |
          mkdir -p reports
          newman run postman/OrdersAPI_AutoGenerated.postman_collection.json \
            --reporters cli,json \
            --reporter-json-export reports/newman-results.json

      - name: Deploy to Kong (Staging)
        env:
          KONG_ADMIN: ${{ secrets.KONG_ADMIN_URL }}
        run: |
          cd scripts
          node deploy-kong.js orders-api https://backend.example.com/orders

      - name: Notify success
        if: success()
        run: echo "✅ API lint, test & deploy successful!"

      - name: Notify failure
        if: failure()
        run: echo "❌ Lint/test/deploy failed. Please check logs."
